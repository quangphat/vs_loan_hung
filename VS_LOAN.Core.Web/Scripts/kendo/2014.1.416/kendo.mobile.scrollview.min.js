/**
 * Copyright 2014 Telerik AD
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * Copyright 2014 Telerik AD
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

!function(e,define){define(["./kendo.fx.min","./kendo.data.min","./kendo.draganddrop.min"],e)}(function(){return function(e,t){var n,i,r,a,o,s,l,u,c=window.kendo,d=c.mobile,h=d.ui,f=e.proxy,p=c.effects.Transition,g=c.ui.Pane,m=c.ui.PaneDimensions,v=h.Widget,_=c.data.DataSource,b=c.data.Buffer,w=c.data.BatchBuffer,y=Math,k=y.abs,x=y.ceil,C=y.round,S=y.max,T=y.min,F=y.floor,D="change",E="changing",M="refresh",O="km-current-page",A="km-virtual-page",P="function",I="itemChange",H=3,z=-1,B=0,R=1,N=-1,V=0,L=1,W=c.Class.extend({init:function(t){var n=this,i=e("<ol class='km-pages'/>");t.element.append(i),this._changeProxy=f(n,"_change"),this._refreshProxy=f(n,"_refresh"),t.bind(D,this._changeProxy),t.bind(M,this._refreshProxy),e.extend(n,{element:i,scrollView:t})},items:function(){return this.element.children()},_refresh:function(e){var t,n="";for(t=0;e.pageCount>t;t++)n+="<li/>";this.element.html(n),this.items().eq(e.page).addClass(O)},_change:function(e){this.items().removeClass(O).eq(e.page).addClass(O)},destroy:function(){this.scrollView.unbind(D,this._changeProxy),this.scrollView.unbind(M,this._refreshProxy),this.element.remove()}});c.mobile.ui.ScrollViewPager=W,n="transitionEnd",i="dragStart",r="dragEnd",a=c.Observable.extend({init:function(t,a){var o,s,l,u,d,h,f=this;c.Observable.fn.init.call(this),this.element=t,this.container=t.parent(),o=new c.ui.Movable(f.element),s=new p({axis:"x",movable:o,onEnd:function(){f.trigger(n)}}),l=new c.UserEvents(t,{start:function(e){2*k(e.x.velocity)>=k(e.y.velocity)?l.capture():l.cancel(),f.trigger(i,e),s.cancel()},allowSelection:!0,end:function(e){f.trigger(r,e)}}),u=new m({element:f.element,container:f.container}),d=u.x,d.bind(D,function(){f.trigger(D)}),h=new g({dimensions:u,userEvents:l,movable:o,elastic:!0}),e.extend(f,{duration:a&&a.duration||1,movable:o,transition:s,userEvents:l,dimensions:u,dimension:d,pane:h}),this.bind([n,i,r,D],a)},size:function(){return{width:this.dimensions.x.getSize(),height:this.dimensions.y.getSize()}},total:function(){return this.dimension.getTotal()},offset:function(){return-this.movable.x},updateDimension:function(){this.dimension.update(!0)},refresh:function(){this.dimensions.refresh()},moveTo:function(e){this.movable.moveAxis("x",-e)},transitionTo:function(e,t,n){n?this.moveTo(-e):this.transition.moveTo({location:e,duration:this.duration,ease:t})}}),c.mobile.ui.ScrollViewElasticPane=a,o=c.Observable.extend({init:function(e,t,n){var i=this;c.Observable.fn.init.call(this),i.element=e,i.pane=t,i._getPages(),this.page=0,this.pageSize=n.pageSize||1,this.contentHeight=n.contentHeight,this.enablePager=n.enablePager},scrollTo:function(e,t){this.page=e,this.pane.transitionTo(-e*this.pane.size().width,p.easeOutExpo,t)},paneMoved:function(e,t,n,i){var r,a,o=this,s=o.pane,l=s.size().width*o.pageSize,u=C,c=t?p.easeOutBack:p.easeOutExpo;e===N?u=x:e===L&&(u=F),a=u(s.offset()/l),r=S(o.minSnap,T(-a*l,o.maxSnap)),a!=o.page&&n&&n({currentPage:o.page,nextPage:a})&&(r=-o.page*s.size().width),s.transitionTo(r,c,i)},updatePage:function(){var e=this.pane,t=C(e.offset()/e.size().width);return t!=this.page?(this.page=t,!0):!1},forcePageUpdate:function(){return this.updatePage()},resizeTo:function(e){var t,n,i=this.pane,r=e.width;this.pageElements.width(r),"100%"===this.contentHeight&&(t=this.element.parent().height(),this.enablePager===!0&&(n=this.element.parent().find("ol.km-pages"),n.length&&(t-=n.outerHeight(!0))),this.element.css("height",t),this.pageElements.css("height",t)),i.updateDimension(),this._paged||(this.page=F(i.offset()/r)),this.scrollTo(this.page,!0),this.pageCount=x(i.total()/r),this.minSnap=-(this.pageCount-1)*r,this.maxSnap=0},_getPages:function(){this.pageElements=this.element.find("[data-role=page]"),this._paged=this.pageElements.length>0}}),c.mobile.ui.ScrollViewContent=o,s=c.Observable.extend({init:function(e,t,n){var i=this;c.Observable.fn.init.call(this),i.element=e,i.pane=t,i.options=n,i._templates(),i.page=n.page||0,i.pages=[],i._initPages(),i.resizeTo(i.pane.size()),i.pane.dimension.forceEnabled()},setDataSource:function(e){this.dataSource=_.create(e),this._buffer(),this._pendingPageRefresh=!1,this._pendingWidgetRefresh=!1},_viewShow:function(){var e=this;e._pendingWidgetRefresh&&(setTimeout(function(){e._resetPages()},0),e._pendingWidgetRefresh=!1)},_buffer:function(){var e=this.options.itemsPerPage;this.buffer&&this.buffer.destroy(),this.buffer=e>1?new w(this.dataSource,e):new b(this.dataSource,3*e),this._resizeProxy=f(this,"_onResize"),this._resetProxy=f(this,"_onReset"),this._endReachedProxy=f(this,"_onEndReached"),this.buffer.bind({resize:this._resizeProxy,reset:this._resetProxy,endreached:this._endReachedProxy})},_templates:function(){var e=this.options.template,t=this.options.emptyTemplate,n={},i={};typeof e===P&&(n.template=e,e="#=this.template(data)#"),this.template=f(c.template(e),n),typeof t===P&&(i.emptyTemplate=t,t="#=this.emptyTemplate(data)#"),this.emptyTemplate=f(c.template(t),i)},_initPages:function(){var e,t,n=this.pages,i=this.element;for(t=0;H>t;t++)e=new l(i),n.push(e);this.pane.updateDimension()},resizeTo:function(e){var t,n,i,r=this.pages,a=this.pane;for(t=0;r.length>t;t++)r[t].setWidth(e.width);"auto"===this.options.contentHeight?this.element.css("height",this.pages[1].element.height()):"100%"===this.options.contentHeight&&(n=this.element.parent().height(),this.options.enablePager===!0&&(i=this.element.parent().find("ol.km-pages"),i.length&&(n-=i.outerHeight(!0))),this.element.css("height",n),r[0].element.css("height",n),r[1].element.css("height",n),r[2].element.css("height",n)),a.updateDimension(),this._repositionPages(),this.width=e.width},scrollTo:function(e){var t,n=this.buffer;n.syncDataSource(),t=n.at(e),t&&(this._updatePagesContent(e),this.page=e)},paneMoved:function(e,t,n,i){var r,a=this,o=a.pane,s=o.size().width,l=o.offset(),u=Math.abs(l)>=s/3,d=t?c.effects.Transition.easeOutBack:c.effects.Transition.easeOutExpo,h=a.page+2>a.buffer.total(),f=0;e===L?0!==a.page&&(f=-1):e!==N||h?l>0&&u&&!h?f=1:0>l&&u&&0!==a.page&&(f=-1):f=1,r=a.page,f&&(r=f>0?r+1:r-1),n&&n({currentPage:a.page,nextPage:r})&&(f=0),0===f?a._cancelMove(d,i):-1===f?a._moveBackward(i):1===f&&a._moveForward(i)},updatePage:function(){var e=this.pages;return 0===this.pane.offset()?!1:(this.pane.offset()>0?(e.push(this.pages.shift()),this.page++,this.setPageContent(e[2],this.page+1)):(e.unshift(this.pages.pop()),this.page--,this.setPageContent(e[0],this.page-1)),this._repositionPages(),this._resetMovable(),!0)},forcePageUpdate:function(){var e=this.pane.offset(),t=3*this.pane.size().width/4;return k(e)>t?this.updatePage():!1},_resetMovable:function(){this.pane.moveTo(0)},_moveForward:function(e){this.pane.transitionTo(-this.width,c.effects.Transition.easeOutExpo,e)},_moveBackward:function(e){this.pane.transitionTo(this.width,c.effects.Transition.easeOutExpo,e)},_cancelMove:function(e,t){this.pane.transitionTo(0,e,t)},_resetPages:function(){this.page=this.options.page||0,this._updatePagesContent(this.page),this._repositionPages(),this.trigger("reset")},_onResize:function(){var e=this.pages[2],t=this.page+1;this._pendingPageRefresh&&(this.setPageContent(e,t),this._pendingPageRefresh=!1)},_onReset:function(){this.pageCount=x(this.dataSource.total()/this.options.itemsPerPage),this.element.is(":visible")?this._resetPages():this._widgetNeedsRefresh=!0},_onEndReached:function(){this._pendingPageRefresh=!0},_repositionPages:function(){var e=this.pages;e[0].position(z),e[1].position(B),e[2].position(R)},_updatePagesContent:function(e){var t=this.pages,n=e||0;this.setPageContent(t[0],n-1),this.setPageContent(t[1],n),this.setPageContent(t[2],n+1)},setPageContent:function(t,n){var i=this.buffer,r=this.template,a=this.emptyTemplate,o=null;n>=0&&(o=i.at(n),e.isArray(o)&&!o.length&&(o=null)),o?t.content(r(o)):t.content(a({})),c.mobile.init(t.element),this.trigger(I,{item:t.element,data:o,ns:c.mobile.ui})}}),c.mobile.ui.VirtualScrollViewContent=s,l=c.Class.extend({init:function(t){this.element=e("<div class='"+A+"'></div>"),this.width=t.width(),this.element.width(this.width),t.append(this.element)},content:function(e){this.element.html(e)},position:function(e){this.element.css("transform","translate3d("+this.width*e+"px, 0, 0)")},setWidth:function(e){this.width=e,this.element.width(e)}}),c.mobile.ui.VirtualPage=l,u=v.extend({init:function(e,t){var n,i,r=this;v.fn.init.call(r,e,t),t=r.options,e=r.element,c.stripWhitespace(e[0]),e.wrapInner("<div/>").addClass("km-scrollview"),this.options.enablePager&&(this.pager=new W(this)),r.inner=e.children().first(),r.page=0,r.inner.css("height",t.contentHeight),r.pane=new a(r.inner,{duration:this.options.duration,transitionEnd:f(this,"_transitionEnd"),dragStart:f(this,"_dragStart"),dragEnd:f(this,"_dragEnd"),change:f(this,M)}),r.bind("resize",function(){r.pane.refresh()}),r.page=t.page,n=0===this.inner.children().length,r._content=n?new s(r.inner,r.pane,t):new o(r.inner,r.pane,t),r._content.page=r.page,r._content.bind("reset",function(){var e=r._content;r._syncWithContent(),r.trigger(M,{pageCount:e.pageCount,page:e.page})}),r._content.bind(I,function(e){r.trigger(I,e)}),r.setDataSource(t.dataSource),i=r.container(),i.nullObject?(r.viewInit(),r.viewShow()):i.bind("show",f(this,"viewShow")).bind("init",f(this,"viewInit"))},options:{name:"ScrollView",page:0,duration:400,velocityThreshold:.8,contentHeight:"auto",pageSize:1,itemsPerPage:1,bounceVelocityThreshold:1.6,enablePager:!0,autoBind:!0,template:"",emptyTemplate:""},events:[E,D,M],destroy:function(){v.fn.destroy.call(this),c.destroy(this.element)},viewInit:function(){this.options.autoBind&&this._content.scrollTo(this._content.page,!0)},viewShow:function(){this.pane.refresh()},refresh:function(){var e=this._content;e.resizeTo(this.pane.size()),this.page=e.page,this.trigger(M,{pageCount:e.pageCount,page:e.page})},content:function(e){this.element.children().first().html(e),this._content._getPages(),this.pane.refresh()},scrollTo:function(e,t){this._content.scrollTo(e,t),this._syncWithContent()},prev:function(){var e=this;e._content.paneMoved(L,t,function(t){return e.trigger(E,t)})},next:function(){var e=this;e._content.paneMoved(N,t,function(t){return e.trigger(E,t)})},setDataSource:function(e){if(this._content instanceof s){var t=!e;this.dataSource=_.create(e),this._content.setDataSource(this.dataSource),this.options.autoBind&&!t&&this.dataSource.fetch()}},items:function(){return this.element.find("."+A)},_syncWithContent:function(){var e,n,i=this._content.pages,r=this._content.buffer;this.page=this._content.page,e=r?r.at(this.page):t,e instanceof Array||(e=[e]),n=i?i[1].element:t,this.trigger(D,{page:this.page,element:n,data:e})},_dragStart:function(){this._content.forcePageUpdate()&&this._syncWithContent()},_dragEnd:function(e){var t=this,n=e.x.velocity,i=this.options.velocityThreshold,r=V,a=k(n)>this.options.bounceVelocityThreshold;n>i?r=L:-i>n&&(r=N),this._content.paneMoved(r,a,function(e){return t.trigger(E,e)})},_transitionEnd:function(){this._content.updatePage()&&this._syncWithContent()}}),h.plugin(u)}(window.kendo.jQuery),window.kendo},"function"==typeof define&&define.amd?define:function(e,t){t()});